# 子比主题-Q群/QQ推送插件使用说明

## 插件简介

本插件是一个WordPress插件，专为子比主题设计，支持在文章发布、更新或收到评论时自动向指定的QQ群发送通知消息。同时支持通过QQ群消息触发网站操作，如论坛签到、账号绑定等功能。

**版本**: 0.0.6  
**原作者**: 落幕（基础推送功能）  
**子比主题适配及扩展功能**: 星野爱 (https://hoshinoai.xin)

## 主要功能

### 1. 文章推送功能
- ✅ 新文章发布时自动推送到QQ群
- ✅ 文章更新时推送通知（可选）
- ✅ 支持文章特色图片或内容图片推送
- ✅ 支持@全体成员功能
- ✅ 支持多个QQ群同时推送
- ✅ 支持论坛帖子推送

### 2. 评论通知功能
- ✅ 新评论时向指定QQ号发送私信通知
- ✅ 支持文章和论坛帖子的评论通知

### 3. QQ群交互功能
- ✅ 论坛账号绑定：`+论坛绑定 邮箱地址`
- ✅ 论坛账号解绑：`+论坛解绑`
- ✅ 论坛签到：`+论坛签到`
- ✅ 最新帖子：`+最新帖子`
- ✅ 搜索帖子：`+搜索 [关键词]`
- ✅ 支持群消息和私信双重回复

## Napcat HTTP服务配置

### HTTP服务端配
在Napcat中创建HTTP服务端：
- **Host地址**: 填写 `0.0.0.0`
- **监听端口**: 填写 `3000`
- **访问令牌**: 填写一个安全的密码（用于验证请求）
- **启用跨域和ws**

### HTTP客户端配置
在Napcat中创建HTTP客户端：
- **URL填写** https://你的域名/wp-json/qqpush/v1/receive


## 插件安装和配置

### 1. 安装插件

1. 将插件文件夹上传到 `/wp-content/plugins/` 目录
2. 在WordPress后台激活插件
3. 确保已安装CSF框架（Codestar Framework）

### 2. 卸载与数据清理

卸载插件时，系统会自动清理以下数据：

1. **插件设置**：所有存储在 `qqpush_options` 中的配置信息
2. **用户元数据**：所有用户的 `qqpush_bound_qq_id` 元数据（QQ号与用户账号的绑定关系）

> 注意：仅在完全卸载插件时才会清理数据，停用插件不会删除任何数据。

### 3. 基础配置

进入WordPress后台 → **子比主题-Q群/QQ推送** 进行配置：

#### API配置
- **API地址**: 填入Napcat服务器地址，如：`http://你的服务器IP:3000`
- **访问令牌**: 填入Napcat配置中的secret（可选）
- **请求超时**: 设置HTTP请求超时时间（默认15秒）

#### 群推送配置
- **QQ群号**: 填入要推送的QQ群号，多个群号用英文逗号分隔
- **启用@全体成员**: 是否在推送时@全体成员
- **启用更新推送**: 是否在文章更新时也发送推送
- **调试模式**: 开启后会在错误日志中记录详细信息

#### 评论通知配置
- **接收通知的QQ号**: 填入接收评论通知的QQ号

#### 论坛功能配置
- **启用账号绑定**: 是否允许用户通过QQ群绑定论坛账号
- **启用群签到**: 是否允许用户通过QQ群进行论坛签到

### 4. API端点

WordPress插件会自动注册以下API端点：
- `POST /wp-json/qqpush/v1/webhook` - 接收QQ群消息

## 使用方法

### 1. 文章推送

配置完成后，当您：
- 发布新文章时，插件会自动向配置的QQ群发送通知
- 更新文章时（如果启用），也会发送更新通知
- 消息格式包含：【分类/板块名称】文章标题、发布时间、文章链接、特色图片等
- 普通文章会显示所属分类，论坛帖子会显示所属板块

### 2. 评论通知

当网站收到新评论时，插件会向配置的QQ号发送私信通知，包含：
- 评论者信息
- 评论内容
- 被评论的文章信息
- 评论时间

### 3. QQ群交互命令

用户可以在QQ群中使用以下命令：

#### 绑定论坛账号
```
+论坛绑定 your_email@example.com
```
- 将QQ号与网站账号进行绑定
- 需要提供注册网站时使用的邮箱地址
- 绑定成功后可以使用签到等功能

#### 论坛签到
```
+论坛签到
```
- 执行论坛每日签到
- 需要先绑定账号
- 会显示签到奖励（积分、经验值等）
- 支持连续签到天数统计

#### 解绑账号
```
+论坛解绑
```
- 解除QQ号与网站账号的绑定关系
- 解绑后无法使用签到等功能

#### 查看最新帖子
```
+最新帖子
```
- 获取论坛最新发布的5篇帖子
- 显示帖子标题、发布时间和链接
- 无需绑定账号即可使用

#### 搜索帖子
```
+搜索 [关键词]
```
- 根据关键词搜索论坛帖子
- 显示最多5个相关度最高的搜索结果
- 包含帖子标题和链接
- 无需绑定账号即可使用
- 需要查看更多结果请前往论坛

## 工作原理

插件通过HTTP协议与Napcat进行双向通信：
- **发送消息**: WordPress插件向Napcat发送HTTP请求推送消息到QQ群
- **接收命令**: Napcat将QQ群消息通过HTTP POST推送到WordPress插件处理

## 故障排除

### 常见问题

1. **消息发送失败**
   - 检查Napcat服务是否正常运行
   - 确认API地址和端口配置正确
   - 检查网络连接是否正常
   - 查看WordPress错误日志

2. **QQ群命令无响应**
   - 确认Webhook配置正确
   - 检查Napcat的postUrls配置
   - 确认WordPress的REST API可以正常访问
   - 开启调试模式查看详细日志

3. **绑定功能异常**
   - 确认邮箱地址与网站注册邮箱一致
   - 检查用户权限设置
   - 确认数据库连接正常

4. **签到功能异常**
   - 确认子比主题的签到功能已启用
   - 检查相关函数是否存在
   - 确认用户已正确绑定账号

### 调试方法

1. **开启调试模式**
   - 在插件设置中开启调试模式
   - 查看WordPress错误日志：`/wp-content/debug.log`

2. **检查API连通性**
   ```bash
   # 测试Napcat API是否可访问
   curl -X POST http://your_server:3000/send_group_msg \
     -H "Content-Type: application/json" \
     -d '{"group_id":"your_group_id","message":"test"}'
   ```

3. **查看Napcat日志**
   - 检查Napcat的运行日志
   - 确认消息发送和接收状态

## 安全注意事项

1. **访问令牌**：设置强密码作为访问令牌
2. **网络安全**：建议使用HTTPS和内网通信
3. **权限控制**：合理设置QQ群管理权限
4. **数据备份**：定期备份绑定关系数据

## 更新日志

### v0.0.6
- 新增"搜索帖子"功能
- 支持通过关键词搜索论坛内容
- 优化搜索结果展示

### v0.0.5
- 新增"最新帖子"功能
- 优化论坛绑定流程
- 改进消息处理逻辑

### v0.0.4
- 新增论坛账号绑定功能
- 新增论坛签到功能
- 新增论坛账号解绑功能
- 优化QQ群消息处理逻辑
- 增强错误处理和日志记录

## 技术支持

如果您在使用过程中遇到问题，可以：

1. 查看本文档的故障排除部分
2. 开启调试模式查看详细日志
3. 访问作者网站：https://hoshinoai.xin
4. 检查Napcat官方文档：https://github.com/NapNeko/NapCatQQ

## 许可证

本插件遵循相应的开源许可证，请在使用前仔细阅读相关条款。

---

**感谢使用子比主题-Q群/QQ推送插件！**